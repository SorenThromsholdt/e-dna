<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eDNA i nicheomr√•der</title>

  <!-- Leaflet CSS -->
  rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    /* ======================================================
       BASE LAYOUT
    ====================================================== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;             /* Prevent entire page scrolling */
      overscroll-behavior: none;    /* Android fix */
      background: #fff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color: #111;
    }

    /* Map must be FIXED to prevent page scrolling */
    #map {
      position: fixed;
      top: 0; left: 0; right: 0;
      width: 100vw;
      height: 100dvh;               /* Mobile-safe height */
      overflow: hidden;
      touch-action: pan-y;          /* Allow internal vertical gestures */
      z-index: 1;
    }

    /* ======================================================
       CSS VARIABLES (JS will update --legend-bottom-safe)
    ====================================================== */
    :root {
      --ui-top-safe: 10px;
      --toggle-row-height: 46px;
      --info-toggle-row: 44px;
      --legend-bottom-safe: 170px;  /* JS will refine this */
    }

    /* ======================================================
       INFO PANEL (RIGHT SIDE)
    ====================================================== */
    .info-panel {
      position: absolute;
      top: var(--ui-top-safe);
      right: 10px;
      z-index: 1100;
      max-width: min(350px, 80vw);
    }

    .info-toggle {
      width: 100%;
      display: flex; justify-content: space-between; align-items: center;
      background: white;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .info-toggle:hover { background: #f5f5f5; }

    .info-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      display: none;
      margin-top: 10px;

      /* KEY LIMITATION: stop above legend */
      max-height: calc(
        100dvh - var(--ui-top-safe) - var(--legend-bottom-safe) - var(--info-toggle-row)
      );

      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .info-content.open { display: block; opacity: 1; transform: translateY(0); }
    .info-content:not(.open) { opacity: 0; transform: translateY(-4px); }

    /* ======================================================
       FILTER PANEL (LEFT SIDE)
    ====================================================== */
    .filter-toggle {
      position: absolute;
      top: var(--ui-top-safe);
      left: 60px;
      z-index: 1200;
      background: white;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .filter-toggle:hover { background: #f5f5f5; }

    .filter-panel {
      position: absolute;
      top: var(--ui-top-safe);
      left: 60px;
      width: min(280px, 70vw);
      max-width: 90vw;
      background: white;
      padding: 12px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1000;
      transition: all 0.2s ease;

      /* KEY LIMITATION: scroll inside + stop above legend */
      max-height: calc(
        100dvh - var(--ui-top-safe) - var(--legend-bottom-safe) - var(--toggle-row-height)
      );
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }

    .filter-panel.with-toggle-offset { margin-top: var(--toggle-row-height); }
    .filter-panel.is-collapsed {
      max-height: 0 !important;
      padding: 0 !important;
      margin-top: 0 !important;
      opacity: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .filter-title { font-weight: 600; color: #1a5f2a; margin-bottom: 8px; }
    .filter-group { margin-bottom: 10px; }
    .filter-label { font-size: 12px; margin-bottom: 4px; display: block; }
    .filter-select, .filter-multiselect {
      width: 100%;
      font-size: 13px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
    }
    .filter-multiselect { height: 140px; }

    /* ======================================================
       LEGEND
    ====================================================== */
    .legend {
      position: absolute;
      bottom: 30px; left: 10px;
      padding: 12px 15px;
      border-radius: 8px;
      background: white;
      font-size: 12px;
      z-index: 1500;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    /* ======================================================
       DOWNLOAD BUTTON + LOADING
    ====================================================== */
    .download-btn {
      position: absolute;
      bottom: 30px; right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-size: 13px;
      cursor: pointer;
    }
    .download-btn:hover { background: #f5f5f5; }

    .loading {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 2000;
    }

    /* ======================================================
       MOBILE LAYOUT
    ====================================================== */
    @media (max-width: 600px) {

      /* Move filter toggle to right of zoom controls */
      .leaflet-top.leaflet-left { margin-top: 10px; margin-left: 10px; }

      .filter-toggle {
        left: calc(10px + 36px + 13px) !important; /* zoom btn width + gap */
      }
      .filter-panel {
        left: calc(10px + 36px + 13px) !important;
        max-width: 55vw;
        width: auto !important;
      }

      .info-panel {
        right: 10px;
        left: auto !important;
        max-width: 55vw;
      }

      .legend { left: 10px; right: 10px; }
      .download-btn { right: 10px; }
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Filter toggle -->
  <button class="filter-toggle" id="filterToggle" aria-controls="filterPanel">
    Filtrering <span id="filterToggleIcon">Ôºã</span>
  </button>

  <!-- Filter Panel -->
  <div id="filterPanel" class="filter-panel with-toggle-offset is-collapsed">
    <div class="filter-title">Filtrer efter art</div>

    <div class="filter-group">
      <label class="filter-label">V√¶lg art(er)</label>
      <select id="speciesSelect" class="filter-multiselect" multiple></select>
    </div>

    <div class="filter-group">
      <label class="filter-label">Registreringsstatus</label>
      <select id="presenceSelect" class="filter-select">
        <option value="absent">Ikke registreret</option>
        <option value="one">Registreret i √©n pr√∏ve</option>
        <option value="both">Registreret i begge pr√∏ver</option>
      </select>
    </div>

    <div class="filter-group filter-row">
      <input type="checkbox" id="matchAll" />
      <label for="matchAll" style="font-size:12px;">Match alle valgte arter</label>
    </div>

    <div class="filter-group">
      <label class="filter-label">Pr√∏vetagningsdato</label>
      <div class="filter-row">
        <input type="date" id="dateFrom" class="filter-select">
        <span style="font-size:12px;">til</span>
        <input type="date" id="dateTo" class="filter-select">
      </div>
    </div>

    <div class="filter-actions">
      <button class="btn btn-primary" id="applyFilterBtn">Anvend filter</button>
      <button class="btn" id="resetFilterBtn">Nulstil</button>
      <div id="filterBadge" class="filter-badge"></div>
    </div>
  </div>

  <!-- INFO PANEL -->
  <div class="info-panel">
    <button class="info-toggle" onclick="toggleInfo()">
      Om projektet <span id="toggle-icon">‚àí</span>
    </button>

    <div class="info-content open" id="info-content">
      <h2>eDNA i nicheomr√•der</h2>
      <p>Dette kort viser resultaterne fra Erhvervsakademi K√∏benhavns forskningsprojekt.</p>
      <p>Projektet udf√∏res i samarbejde mellem Erhvervsakademi K√∏benhavn, Statens Naturhistoriske Museum og Milj√∏styrelsen.</p>

      <h3>Kontakt</h3>
      <p>Navn: S√∏ren Thromsholdt Christensen<br>
         E-mail: <a class="contact-link" href="mailto:stc@ek.dk">stc@ek.dk</a></p>
    </div>
  </div>

  <!-- LEGEND -->
  <div class="legend">
    <div class="legend-title">Artsregistrering</div>
    <div class="legend-item"><div class="legend-color" style="background:#28a745"></div> Registreret i begge pr√∏ver</div>
    <div class="legend-item"><div class="legend-color" style="background:#d4edda"></div> Registreret i √©n pr√∏ve</div>
    <div class="legend-item"><div class="legend-color" style="background:#f8d7da"></div> Ikke registreret</div>
    <div class="legend-item"><div class="legend-color" style="background:#e9ecef"></div> Ikke analyseret</div>
  </div>

  <button class="download-btn" onclick="downloadData()">üì• Hent data</button>
  <div class="loading" id="loading">Indl√¶ser data...</div>

  <!-- JS LIBS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* ======================================================
       CONFIG
    ====================================================== */
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFtEG7yEULkEI2LrdnqX_ZNbHf0VzTBuJpz6r3sPpFeWbrqyzMvWEkpE6mfD9WRSnqo_G8Pw-GT1P5/pub?gid=0&single=true&output=csv";

    const SPECIES_COLUMNS = [
      "Aborre","Trepigget hundestejle","Europ√¶isk √•l","Stor vandsalamander",
      "Solaborre","Vandremusling","Lille vandsalamander","Prymnesium parvum",
      "Flodkrebs","Signalkrebs","Galizisk sumpkrebs","R√∏d√∏ret terrapin",
      "Gr√∏nbroget tudse","Strandtudse","Europ√¶isk malle","Karpe"
    ];

    /* ======================================================
       MAP INIT
    ====================================================== */
    const map = L.map("map").setView([55.9, 11.5], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    /* ======================================================
       TOGGLES (auto collapse)
    ====================================================== */
    function toggleFilterPanel() {
      const panel = document.getElementById("filterPanel");
      const icon = document.getElementById("filterToggleIcon");
      const isOpening = panel.classList.contains("is-collapsed");

      if (isOpening && window.innerWidth <= 600) {
        document.getElementById("info-content").classList.remove("open");
        document.getElementById("toggle-icon").textContent = "+";
      }

      const collapsed = panel.classList.toggle("is-collapsed");
      icon.textContent = collapsed ? "Ôºã" : "‚àí";
    }

    function toggleInfo() {
      const panel = document.getElementById("filterPanel");
      const content = document.getElementById("info-content");
      const icon = document.getElementById("toggle-icon");
      const isOpening = !content.classList.contains("open");

      if (isOpening && window.innerWidth <= 600) {
        panel.classList.add("is-collapsed");
        document.getElementById("filterToggleIcon").textContent = "Ôºã";
      }

      content.classList.toggle("open");
      icon.textContent = content.classList.contains("open") ? "‚àí" : "+";
    }

    /* ======================================================
       DOWNLOAD FILTERED DATA
    ====================================================== */
    function downloadData() {
      const filtered = markers.getLayers().map(m => m.featureData);
      if (filtered.length === 0) return alert("Ingen filtrerede data at downloade.");

      const csv = Papa.unparse(filtered);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "edna-filtered.csv";
      a.click();
    }

    /* ======================================================
       UTILITIES
    ====================================================== */
    function parseNumber(v) {
      if (!v) return NaN;
      return parseFloat(String(v).replace(",", "."));
    }

    function getSpeciesClass(val) {
      if (val === "" || val === null || val === undefined) return "species-empty";
      const n = parseInt(val, 10);
      return n === 2 ? "species-2"
          1 ? "species-1"
           : n === 0 ? "species-0"
           : "species-empty";
    }

    function parseShortDanishDate(str) {
      if (!str) return null;
      str = str.trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(str))
        return new Date(str + "T00:00:00");

      const m = str.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2}|\d{4})$/);
      if (!m) return null;

      let [_, d, mo, y] = m;
      d = parseInt(d); mo = parseInt(mo) - 1; y = parseInt(y);
      if (y < 100) y += 2000;

      return new Date(y, mo, d);
    }

    function parseDateFromInput(v) {
      if (!v) return null;
      return new Date(v + "T00:00:00");
    }

    function dateMatches(str, fromStr, toStr) {
      if (!fromStr && !toStr) return true;
      const d = parseShortDanishDate(str);
      if (!d) return false;

      const from = parseDateFromInput(fromStr);
      const to = parseDateFromInput(toStr);

      if (from && d < from) return false;

      if (to) {
        const end = new Date(to.getFullYear(), to.getMonth(), to.getDate() + 1);
        if (d >= end) return false;
      }

      return true;
    }

    /* ======================================================
       POPUP CONTENT
    ====================================================== */
    function createPopupContent(row) {
      const lokalitet = row["Lokalitet"] || "Ukendt lokalitet";
      const provenr = row["Pr√∏venr."] || "";
      const dato = row["Indsamlingsdato"] || "";
      const vandml = row["Vandmilj√∏"] || "";

      let html = `<div class="popup-header">${lokalitet}</div>`;

      html += `<div class="popup-section">
                 <div class="popup-section-title">Pr√∏veinfo</div>
                 ${provenr ? `<div class="popup-row"><span class="popup-label">Pr√∏venr.</span><span class="popup-value">${provenr}</span></div>` : ""}
                 ${dato ? `<div class="popup-row"><span class="popup-label">Dato</span><span class="popup-value">${dato}</span></div>` : ""}
                 ${vandml ? `<div class="popup-row"><span class="popup-label">Vandmilj√∏</span><span class="popup-value">${vandml}</span></div>` : ""}
               </div>`;

      html += `<div class="popup-section">
                 <div class="popup-section-title">Arter</div>
                 <div class="species-grid">`;

      for (const sp of SPECIES_COLUMNS)
        html += `<span class="species-badge ${getSpeciesClass(row[sp])}">${sp}</span>`;

      html += `</div></div>`;
      return html;
    }

    /* ======================================================
       FILTER LOGIC
    ====================================================== */
    let allMarkers = [];
    let allBounds = [];
    const markers = L.markerClusterGroup({
      maxClusterRadius: 50,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true
    });

    function updateBadge(count) {
      const badge = document.getElementById("filterBadge");
      const anySpecies = getSelectedSpecies().length > 0;
      const hasDate = document.getElementById("dateFrom").value || document.getElementById("dateTo").value;

      if (count === allMarkers.length && !anySpecies && !hasDate) {
        badge.style.display = "none";
        return;
      }

      badge.style.display = "inline-block";
      badge.textContent = `${count} resultater`;
    }

    function getSelectedSpecies() {
      return [...document.getElementById("speciesSelect").selectedOptions].map(o => o.value);
    }
    function getPresenceMode() { return document.getElementById("presenceSelect").value; }
    function getMatchAll()   { return document.getElementById("matchAll").checked; }

    function valueMatchesMode(val, mode) {
      if (val === null || val === "" || val === undefined) return false;
      const n = parseInt(val, 10);
      return (mode === "both" && n === 2) ||
             (mode === "one"  && n === 1) ||
             (mode === "absent" && n === 0);
    }

    function applyFilter({ fit = false } = {}) {
      const species = getSelectedSpecies();
      const mode = getPresenceMode();
      const matchAll = getMatchAll();
      const from = document.getElementById("dateFrom").value;
      const to = document.getElementById("dateTo").value;

      markers.clearLayers();

      const kept = allMarkers.filter(m => {
        const row = m.featureData;

        /* date filter */
        if (!dateMatches(row["Indsamlingsdato"], from, to))
          return false;

        /* species filter */
        if (species.length > 0) {
          const results = species.map(sp => valueMatchesMode(row[sp], mode));
          if (matchAll ? !results.every(Boolean) : !results.some(Boolean))
            return false;
        }

        return true;
      });

      markers.addLayers(kept);
      updateBadge(kept.length);

      if (fit && kept.length > 0) {
        map.fitBounds(kept.map(m => m.getLatLng()), { padding: [50, 50] });
      }
    }

    function resetFilter() {
      document.getElementById("speciesSelect").selectedIndex = -1;
      document.getElementById("presenceSelect").value = "absent";
      document.getElementById("matchAll").checked = false;
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";

      markers.clearLayers();
      markers.addLayers(allMarkers);
      updateBadge(allMarkers.length);

      if (allBounds.length > 0)
        map.fitBounds(allBounds, { padding: [50, 50] });
    }

    /* ======================================================
       INIT FILTER UI
    ====================================================== */
    function initFilterUI() {
      const sel = document.getElementById("speciesSelect");
      SPECIES_COLUMNS.forEach(sp => {
        const o = document.createElement("option");
        o.value = sp;
        o.textContent = sp;
        sel.appendChild(o);
      });

      document.getElementById("applyFilterBtn").onclick = () => applyFilter({ fit: true });
      document.getElementById("resetFilterBtn").onclick = resetFilter;

      document.getElementById("speciesSelect").onchange = () => applyFilter();
      document.getElementById("presenceSelect").onchange = () => applyFilter();
      document.getElementById("matchAll").onchange = () => applyFilter();
      document.getElementById("dateFrom").onchange = () => applyFilter();
      document.getElementById("dateTo").onchange = () => applyFilter();

      /* Multi-select toggle behavior */
      sel.addEventListener("mousedown", function(e) {
        e.preventDefault();
        if (e.target.tagName === "OPTION") {
          e.target.selected = !e.target.selected;
          sel.dispatchEvent(new Event("change"));
        }
      });

      document.getElementById("filterToggle")
        .addEventListener("click", toggleFilterPanel);
    }

    /* ======================================================
       UPDATE SPACE ABOVE LEGEND
    ====================================================== */
    function setLegendSafeArea() {
      const legend = document.querySelector(".legend");
      if (!legend) return;

      const needed = legend.offsetHeight + 18; /* 10px + cushion */
      document.documentElement.style.setProperty("--legend-bottom-safe", needed + "px");
    }

    window.addEventListener("load", setLegendSafeArea);
    window.addEventListener("resize", setLegendSafeArea);
    window.addEventListener("orientationchange", setLegendSafeArea);
    setTimeout(setLegendSafeArea, 500);
    setTimeout(setLegendSafeArea, 1500);

    /* ======================================================
       LOAD DATA
    ====================================================== */
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete(results) {
        loading.style.display = "none";

        const bounds = [];

        results.data.forEach(row => {
          const lat = parseNumber(row["Y-koordinat"]);
          const lng = parseNumber(row["X-koordinat"]);
          if (!isNaN(lat) && !isNaN(lng)) {
            const m = L.marker([lat, lng]);
            m.bindPopup(createPopupContent(row));
            m.featureData = row;
            allMarkers.push(m);
            bounds.push([lat, lng]);
          }
        });

        markers.addLayers(allMarkers);
        allBounds = bounds;

        if (bounds.length > 0)
          map.fitBounds(bounds, { padding: [50, 50] });

        initFilterUI();
        updateBadge(allMarkers.length);
      },
      error(err) {
        loading.textContent = "Fejl ved indl√¶sning af data";
        console.error(err);
      }
    });
  </script>
</body>
</html>
