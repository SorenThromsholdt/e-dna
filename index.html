
<!DOCTYPE html>
<html lang=\"da\">
<head>
  <meta charset=\"UTF-8\" />
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>
  <title>eDNA i nicheomr√•der</title>

  <!-- Leaflet & MarkerCluster CSS -->
  <link
    rel=\"stylesheet\"
    href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\"
    integrity=\"sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=\"
    crossorigin=\"\"
  />
  <link
    rel=\"stylesheet\"
    href=\"https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css\"
  />
  <link
    rel=\"stylesheet\"
    href=\"https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css\"
  />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; overscroll-behavior: none; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      color: #111;
    }

    #map {
      width: 100vw;
      height: 100dvh;
      position: fixed;
      top: 0; left: 0; right: 0;
      overflow: hidden;
    }

    :root{
      --ui-top-safe: 10px;
      --toggle-row-height: 46px;
      --info-toggle-row: 44px;
      --legend-bottom-safe: 170px;
    }

    /* Info panel */
    .info-panel { position: absolute; top: var(--ui-top-safe); right: 10px; z-index: 1000; max-width: min(350px, 80vw); }
    .info-toggle { background: white; border: none; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: space-between; }
    .info-content { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); padding: 20px; margin-top: 10px; display: none; max-height: calc(100dvh - var(--ui-top-safe) - var(--legend-bottom-safe) - var(--info-toggle-row) - 10px); overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .info-content.open { display: block; }

    /* Filters */
    .filter-toggle { position: absolute; top: var(--ui-top-safe); left: 60px; z-index: 1300; background: white; border: none; padding: 10px 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .filter-panel { position: absolute; top: var(--ui-top-safe); left: 60px; z-index: 1000; background: white; padding: 12px 14px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); width: min(280px, 70vw); max-width: 90vw; transition: 0.2s ease; max-height: calc(100dvh - var(--ui-top-safe) - var(--legend-bottom-safe) - var(--toggle-row-height)); overflow-y: auto; }
    .filter-panel.is-collapsed { max-height: 0 !important; padding: 0 !important; margin-top: 0 !important; opacity: 0; overflow: hidden; pointer-events: none; }

    .filter-badge { background:#1a5f2a; color:white; padding:4px 10px; border-radius:12px; font-size:12px; display:none; width:fit-content; margin-top:8px; }

    .species-list { border: 1px solid #ddd; border-radius: 6px; padding: 6px; height: 140px; overflow-y: auto; background: #fff; }
    .species-item { display: flex; align-items: center; gap: 6px; font-size: 13px; padding: 4px 0; }

    /* Legend */
    .legend { position: absolute; bottom: 30px; left: 10px; z-index: 1100; background: white; padding: 12px 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-size: 12px; }

    .download-btn { position: absolute; bottom: 30px; right: 10px; z-index: 1000; background: white; border: none; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); cursor: pointer; font-size: 13px; font-weight: 500; }

    /* Popup styles (optional) */
    .leaflet-popup-content { min-width: 250px; max-width: 320px; }
    .popup-header { font-size: 16px; font-weight: 600; color: #1a5f2a; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0; }
    .popup-section { margin-bottom: 12px; }
    .popup-section-title { font-size: 13px; font-weight: 600; color: #666; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .popup-row { display: flex; justify-content: space-between; font-size: 13px; padding: 3px 0; }
    .popup-label { color: #666; }
    .popup-value { font-weight: 500; color: #333; }

    .species-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .species-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
    .species-2 { background: #28a745; color: #ffffff; }
    .species-1 { background: #d4edda; color: #155724; }
    .species-0 { background: #f8d7da; color: #721c24; }
    .species-empty { background: #e9ecef; color: #6c757d; }
  </style>
</head>
<body>
  <div id=\"map\"></div>

  <!-- Filter Toggle -->
  <button class=\"filter-toggle\" id=\"filterToggle\" aria-controls=\"filterPanel\" aria-expanded=\"false\">
    <span>Filtrering</span>
    <span id=\"filterToggleIcon\">Ôºã</span>
  </button>

  <!-- Filter panel -->
  <div class=\"filter-panel is-collapsed\" id=\"filterPanel\">
    <div class=\"filter-title\">Filtrer efter art</div>

    <div class=\"filter-group\">
      <label class=\"filter-label\">V√¶lg art(er)</label>
      <div id=\"speciesSelect\" class=\"species-list\"></div>
    </div>

    <div class=\"filter-group\">
      <label class=\"filter-label\">Registreringsstatus</label>
      <select id=\"presenceSelect\" class=\"filter-select\">
        <option value=\"absent\">Ikke registreret</option>
        <option value=\"one\">Registreret i √©n pr√∏ve</option>
        <option value=\"both\" selected>Registreret i begge pr√∏ver</option>
      </select>
    </div>

    <div class=\"filter-group\">
      <input type=\"checkbox\" id=\"matchAll\" />
      <label for=\"matchAll\">Match alle valgte arter</label>
    </div>

    <div class=\"filter-group\">
      <label class=\"filter-label\">Pr√∏vetagningsdato</label>
      <div class=\"filter-row\">
        <input type=\"date\" id=\"dateFrom\" class=\"filter-select\" />
        <span style=\"font-size:12px;\">til</span>
        <input type=\"date\" id=\"dateTo\" class=\"filter-select\" />
      </div>
    </div>

    <button class=\"btn btn-primary\" id=\"applyFilterBtn\">Anvend filter</button>
    <button class=\"btn\" id=\"resetFilterBtn\">Nulstil</button>

    <div id=\"filterBadge\" class=\"filter-badge\"></div>
  </div>

  <!-- Info panel -->
  <div class=\"info-panel\">
    <button class=\"info-toggle\" onclick=\"toggleInfo()\" aria-expanded=\"true\">
      <span>Om projektet</span>
      <span id=\"toggle-icon\">‚àí</span>
    </button>
    <div class=\"info-content open\" id=\"info-content\">
      <h2>eDNA i nicheomr√•der</h2>
      <p>Dette kort viser resultaterne fra Erhvervsakademi K√∏benhavns forskningsprojekt.</p>
    </div>
  </div>

  <!-- Legend -->
  <div class=\"legend\">
    <div class=\"legend-title\">Artsregistrering</div>
    <div class=\"legend-item\"><div class=\"legend-color\" style=\"background: #28a745; width:16px; height:16px; border-radius:10px; margin-right:8px; display:inline-block;\"></div>Registreret i begge pr√∏ver</div>
    <div class=\"legend-item\"><div class=\"legend-color\" style=\"background: #d4edda; width:16px; height:16px; border-radius:10px; margin-right:8px; display:inline-block;\"></div>Registreret i √©n pr√∏ve</div>
    <div class=\"legend-item\"><div class=\"legend-color\" style=\"background: #f8d7da; width:16px; height:16px; border-radius:10px; margin-right:8px; display:inline-block;\"></div>Ikke registreret</div>
    <div class=\"legend-item\"><div class=\"legend-color\" style=\"background: #e9ecef; width:16px; height:16px; border-radius:10px; margin-right:8px; display:inline-block;\"></div>Ikke analyseret</div>
  </div>

  <button class=\"download-btn\" onclick=\"downloadData()\">üì• Hent data</button>

  <div class=\"loading\" id=\"loading\">Indl√¶ser data...</div>

  <!-- Leaflet JS -->
  <script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\" integrity=\"sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=\" crossorigin=\"\"></script>
  <script src=\"https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js\"></script>
  <script src=\"https://unpkg.com/papaparse@5.4.1/papaparse.min.js\"></script>

  <script>
  // --- Config ---
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFtEG7yEULkEI2LrdnqX_ZNbHf0VzTBuJpz6r3sPpFeWbrqyzMvWEkpE6mfD9WRSnqo_G8Pw-GT1P5/pub?gid=0&single=true&output=csv';

  const SPECIES_COLUMNS = [
    'Aborre', 'Trepigget hundestejle', 'Europ√¶isk √•l', 'Stor vandsalamander',
    'Solaborre', 'Vandremusling', 'Lille vandsalamander', 'Prymnesium parvum',
    'Flodkrebs', 'Signalkrebs', 'Galizisk sumpkrebs', 'R√∏d√∏ret terrapin',
    'Gr√∏nbroget tudse', 'Strandtudse', 'Europ√¶isk malle', 'Karpe'
  ];

  // --- Map init ---
  const map = L.map('map').setView([55.9, 11.5], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  // Cluster layer
  const markers = L.markerClusterGroup({ maxClusterRadius: 50, spiderfyOnMaxZoom: true, showCoverageOnHover: false, zoomToBoundsOnClick: true });
  map.addLayer(markers);

  // --- UI toggles ---
  function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    const btn = document.getElementById('filterToggle');
    const icon = document.getElementById('filterToggleIcon');
    const collapsed = panel.classList.toggle('is-collapsed');
    btn.setAttribute('aria-expanded', (!collapsed).toString());
    icon.textContent = collapsed ? 'Ôºã' : '‚àí';
  }
  function toggleInfo() {
    const content = document.getElementById('info-content');
    const icon = document.getElementById('toggle-icon');
    const nowOpen = !content.classList.contains('open');
    content.classList.toggle('open');
    icon.textContent = nowOpen ? '‚àí' : '+';
    document.querySelector('.info-toggle').setAttribute('aria-expanded', nowOpen.toString());
  }

  // --- Download (kun filtrerede data) ---
  function downloadData() {
    const filtered = markers.getLayers().map(m => m.featureData);
    if (filtered.length === 0) return alert('Ingen filtrerede data at downloade.');
    const csv = Papa.unparse(filtered);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'edna-filtered.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // --- Helpers ---
  function parseNumber(value) { if (value === '' || value == null) return NaN; return parseFloat(String(value).replace(',', '.')); }
  function getSpeciesClass(value) { if (value === '' || value == null) return 'species-empty'; const n = parseInt(value, 10); if (n === 2) return 'species-2'; if (n === 1) return 'species-1'; if (n === 0) return 'species-0'; return 'species-empty'; }
  function parseShortDanishDate(str) {
    if (!str) return null; const s = String(str).trim();
    if (/^\\d{4}-\\d{2}-\\d{2}$/.test(s)) { const d = new Date(s + 'T00:00:00'); return isNaN(d) ? null : d; }
    const m = s.match(/^(\\d{1,2})-\\/.-\\/.$/);
    if (m) { let day = parseInt(m[1],10), month = parseInt(m[2],10)-1, year = parseInt(m[3],10); if (year<100) year += 2000; const d = new Date(year, month, day); return isNaN(d) ? null : d; }
    return null;
  }
  function parseDateFromInput(value) { if (!value) return null; const d = new Date(value + 'T00:00:00'); return isNaN(d) ? null : d; }
  function dateMatches(rowDateStr, fromStr, toStr) {
    const hasRange = !!fromStr || !!toStr; if (!hasRange) return true;
    const rowDate = parseShortDanishDate(rowDateStr); if (!rowDate) return false;
    const from = parseDateFromInput(fromStr); const to = parseDateFromInput(toStr);
    if (from && rowDate < from) return false;
    if (to) { const toInclusive = new Date(to.getFullYear(), to.getMonth(), to.getDate() + 1); if (rowDate >= toInclusive) return false; }
    return true;
  }

  function createPopupContent(row) {
    const lokalitet = row['Lokalitet'] || 'Ukendt lokalitet';
    const provenr = row['Pr√∏venr.'] || ''; const dato = row['Indsamlingsdato'] || ''; const vandmiljo = row['Vandmilj√∏'] || '';
    let html = `<div class=\"popup-header\">${lokalitet}</div>`;
    html += `<div class=\"popup-section\">`;
    html += `<div class=\"popup-section-title\">Pr√∏veinfo</div>`;
    if (provenr) html += `<div class=\"popup-row\"><span class=\"popup-label\">Pr√∏venr.</span><span class=\"popup-value\">${provenr}</span></div>`;
    if (dato) html += `<div class=\"popup-row\"><span class=\"popup-label\">Dato</span><span class=\"popup-value\">${dato}</span></div>`;
    if (vandmiljo) html += `<div class=\"popup-row\"><span class=\"popup-label\">Vandmilj√∏</span><span class=\"popup-value\">${vandmiljo}</span></div>`;
    html += `</div>`;
    html += `<div class=\"popup-section\"><div class=\"popup-section-title\">Arter</div><div class=\"species-grid\">`;
    SPECIES_COLUMNS.forEach(sp => { const value = row[sp]; const cssClass = getSpeciesClass(value); const label = (value === '' || value == null) ? sp : `${sp} (${value})`; const title = (value === '2') ? 'Registreret i begge pr√∏ver' : (value === '1') ? 'Registreret i √©n pr√∏ve' : (value === '0') ? 'Ikke registreret' : 'Ikke analyseret'; html += `<span class=\"species-badge ${cssClass}\" title=\"${title}\">${label}</span>`; });
    html += `</div></div>`; return html;
  }

  // --- Filter state ---
  let allMarkers = []; let allLatLngs = [];
  function valueMatchesMode(cellValue, mode) {
    const v = (cellValue == null) ? '' : String(cellValue).trim(); if (v === '') return false; const n = parseInt(v,10); if (Number.isNaN(n)) return false; if (mode==='both') return n===2; if (mode==='one') return n===1; if (mode==='absent') return n===0; return false;
  }
  function getSelectedSpecies(){ return Array.from(document.querySelectorAll('#speciesSelect input:checked')).map(cb=>cb.value); }
  function getPresenceMode(){ return document.getElementById('presenceSelect').value; }
  function getMatchAll(){ return document.getElementById('matchAll').checked; }

  function updateBadge(count){
    const badge = document.getElementById('filterBadge'); const selectedSpecies = getSelectedSpecies(); const mode=getPresenceMode(); const matchAll=getMatchAll(); const dateFrom=document.getElementById('dateFrom').value; const dateTo=document.getElementById('dateTo').value; const hasSpecies=selectedSpecies.length>0; const hasDate=!!dateFrom||!!dateTo; if(!hasSpecies && !hasDate){ badge.style.display='none'; return; }
    const speciesLabel = hasSpecies ? `${selectedSpecies.length} art${selectedSpecies.length>1?'er':''}` : null;
    const modeLabel = hasSpecies ? (mode==='both'?'begge pr√∏ver': mode==='one'?'√©n pr√∏ve':'ingen registrering') : null;
    const matchLabel = hasSpecies && selectedSpecies.length>1 ? (matchAll?'match alle':'match mindst √©n') : null;
    const dateLabel = hasDate ? `dato: ${dateFrom||'?'} ‚Üí ${dateTo||'?'}` : null;
    badge.textContent = [ `${count} resultater`, speciesLabel, modeLabel?`status: ${modeLabel}`:null, matchLabel, dateLabel ].filter(Boolean).join(' ‚Ä¢ ');
    badge.style.display='inline-block';
  }

  function applyFilter({fit=false}={}){
    const selectedSpecies=getSelectedSpecies(); const mode=getPresenceMode(); const matchAll=getMatchAll(); const dateFrom=document.getElementById('dateFrom').value; const dateTo=document.getElementById('dateTo').value; const hasSpecies=selectedSpecies.length>0;
    markers.clearLayers(); const kept=[];
    for(const m of allMarkers){ const row=m.featureData; if(!dateMatches(row['Indsamlingsdato'], dateFrom, dateTo)) continue; if(hasSpecies){ const results=selectedSpecies.map(sp=>valueMatchesMode(row[sp], mode)); const ok=matchAll?results.every(Boolean):results.some(Boolean); if(!ok) continue; } kept.push(m); }
    if(kept.length>0) markers.addLayers(kept);
    updateBadge(kept.length);
    if(fit && kept.length>0){ const b=kept.map(m=>m.getLatLng()); map.fitBounds(L.latLngBounds(b), { padding:[50,50] }); }
  }

  function resetFilter(){
    document.querySelectorAll('#speciesSelect input[type=\"checkbox\"]').forEach(cb=>cb.checked=false);
    document.getElementById('presenceSelect').value='both';
    document.getElementById('matchAll').checked=false;
    document.getElementById('dateFrom').value='';
    document.getElementById('dateTo').value='';
    markers.clearLayers(); if(allMarkers.length) markers.addLayers(allMarkers);
    document.getElementById('filterBadge').style.display='none';
    if(allLatLngs.length) map.fitBounds(L.latLngBounds(allLatLngs), { padding:[50,50] });
  }

  function initFilterUI(){
    const list=document.getElementById('speciesSelect'); list.innerHTML='';
    SPECIES_COLUMNS.forEach(sp=>{ const div=document.createElement('div'); div.className='species-item'; const cb=document.createElement('input'); cb.type='checkbox'; cb.value=sp; cb.id=`species_${sp.replace(/\\s+/g,'_')}`; cb.addEventListener('change',()=>applyFilter()); const label=document.createElement('label'); label.setAttribute('for', cb.id); label.textContent=sp; div.appendChild(cb); div.appendChild(label); list.appendChild(div); });
    document.getElementById('applyFilterBtn').addEventListener('click',()=>applyFilter({fit:true}));
    document.getElementById('resetFilterBtn').addEventListener('click',resetFilter);
    document.getElementById('presenceSelect').addEventListener('change',()=>applyFilter());
    document.getElementById('matchAll').addEventListener('change',()=>applyFilter());
    document.getElementById('dateFrom').addEventListener('change',()=>applyFilter());
    document.getElementById('dateTo').addEventListener('change',()=>applyFilter());
    document.getElementById('filterToggle').addEventListener('click',toggleFilterPanel);
  }

  // --- Legend safe area ---
  function setLegendSafeArea(){ const legend=document.querySelector('.legend'); if(!legend) return; const distance=10, cushion=8; const h=legend.offsetHeight+distance+cushion; document.documentElement.style.setProperty('--legend-bottom-safe', h+'px'); }
  window.addEventListener('load', setLegendSafeArea);
  window.addEventListener('resize', setLegendSafeArea);
  window.addEventListener('orientationchange', setLegendSafeArea);
  setTimeout(setLegendSafeArea, 500);
  setTimeout(setLegendSafeArea, 1500);

  // --- Data load ---
  Papa.parse(CSV_URL, {
    download: true, header: true, skipEmptyLines: true,
    complete: function(results){
      const loading=document.getElementById('loading'); if(loading) loading.style.display='none';
      const latlngs=[];
      results.data.forEach(row=>{ const lat=parseNumber(row['Y-koordinat']); const lng=parseNumber(row['X-koordinat']); if(!isNaN(lat) && !isNaN(lng)){ const marker=L.marker([lat,lng]); marker.bindPopup(createPopupContent(row), {maxWidth:350, maxHeight:400}); marker.featureData=row; allMarkers.push(marker); latlngs.push([lat,lng]); } });
      if(allMarkers.length) markers.addLayers(allMarkers);
      allLatLngs=latlngs; if(latlngs.length) map.fitBounds(L.latLngBounds(latlngs), { padding:[50,50] });
      initFilterUI(); updateBadge(allMarkers.length);
    },
    error: function(err){ const loading=document.getElementById('loading'); if(loading) loading.textContent='Fejl ved indl√¶sning af data'; console.error('
