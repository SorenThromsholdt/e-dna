<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eDNA i nicheomr√•der</title>

  <!-- Leaflet & MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
    #map { width: 100vw; height: 100vh; }

    .info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      max-width: 350px;
    }
    .info-toggle {
      background: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .info-toggle:hover { background: #f5f5f5; }
    .info-content {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      padding: 20px;
      margin-top: 10px;
      display: none;
      max-height: 70vh;
      overflow-y: auto;
    }
    .info-content.open { display: block; }
    .info-content h2 { font-size: 18px; margin-bottom: 12px; color: #1a5f2a; }
    .info-content p { font-size: 14px; line-height: 1.6; color: #333; margin-bottom: 12px; }
    .info-content h3 { font-size: 15px; margin-top: 16px; margin-bottom: 8px; color: #1a5f2a; }
    .info-content address {
      font-style: normal; background: #f0f7f1; padding: 8px 12px; border-radius: 4px; font-size: 13px;
    }

    /* Popup styling */
    .leaflet-popup-content { min-width: 250px; max-width: 320px; }
    .popup-header {
      font-size: 16px; font-weight: 600; color: #1a5f2a;
      margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0;
    }
    .popup-section { margin-bottom: 12px; }
    .popup-section-title {
      font-size: 13px; font-weight: 600; color: #666; margin-bottom: 6px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .popup-row {
      display: flex; justify-content: space-between; font-size: 13px; padding: 3px 0;
    }
    .popup-label { color: #666; }
    .popup-value { font-weight: 500; color: #333; }

    .species-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .species-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
    .species-2 { background: #28a745; color: #ffffff; }
    .species-1 { background: #d4edda; color: #155724; }
    .species-0 { background: #f8d7da; color: #721c24; }
    .species-empty { background: #e9ecef; color: #6c757d; }

    .legend {
      position: absolute; bottom: 30px; left: 10px; z-index: 1000;
      background: white; padding: 12px 15px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-size: 12px;
    }
    .legend-title { font-weight: 600; margin-bottom: 8px; color: #333; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .legend-color { width: 16px; height: 16px; border-radius: 10px; }

    .download-btn {
      position: absolute; bottom: 30px; right: 10px; z-index: 1000;
      background: white; border: none; padding: 10px 15px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15); cursor: pointer;
      font-size: 13px; font-weight: 500; color: #333; transition: background 0.2s;
    }
    .download-btn:hover { background: #f5f5f5; }

    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 1000; background: white; padding: 20px 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15); font-size: 14px;
    }

    /* --- Filter toggle button --- */
    .filter-toggle {
      position: absolute;
      top: 10px;
      left: 60px; /* moved right to avoid overlap with zoom controls */
      z-index: 1001;
      background: white;
      border: none;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-toggle:hover { background: #f5f5f5; }

    /* Filter panel */
    .filter-panel {
      position: absolute;
      top: 10px;
      left: 60px; /* moved right together with toggle */
      z-index: 1000;
      background: white;
      padding: 12px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      width: 280px;
      transition: max-height 0.2s ease, opacity 0.2s ease, padding 0.2s ease, margin 0.2s ease;
    }
    /* Provide space so panel sits below the toggle button */
    .filter-panel.with-toggle-offset { margin-top: 46px; }

    /* Collapsed state */
    .filter-panel.is-collapsed {
      max-height: 0 !important;
      padding: 0 0 !important;
      margin-top: 0 !important;
      opacity: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .filter-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #1a5f2a; }
    .filter-group { margin-bottom: 10px; }
    .filter-label { font-size: 12px; color: #444; margin-bottom: 4px; display: block; }
    .filter-select, .filter-multiselect {
      width: 100%;
      font-size: 13px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
    }
    .filter-multiselect { height: 140px; }
    .filter-row { display: flex; align-items: center; gap: 8px; }
    .filter-actions { display: flex; gap: 8px; }
    .btn {
      border: none; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 13px;
      background: #f1f3f5; color: #333;
    }
    .btn:hover { background: #e9ecef; }
    .btn-primary { background: #1a5f2a; color: white; }
    .btn-primary:hover { background: #154c21; }

    .contact-link {
      color: #000;
      text-decoration: none;
      transition: color 0.2s ease, text-decoration-color 0.2s ease;
    }
    .contact-link:hover,
    .contact-link:focus {
      color: #000;
      text-decoration: underline;
    }
    .contact-link:focus {
      outline: 2px solid rgba(0,0,0,0.25);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Filter toggle (starts collapsed: aria-expanded="false" and + icon) -->
  <button class="filter-toggle" id="filterToggle" aria-controls="filterPanel" aria-expanded="false">
    <span>Filtrering</span>
    <span id="filterToggleIcon">Ôºã</span>
  </button>

  <!-- Filter panel (starts collapsed via is-collapsed) -->
  <div class="filter-panel with-toggle-offset is-collapsed" id="filterPanel" aria-label="Filter for arter">
    <div class="filter-title">Filtrer efter art</div>

    <div class="filter-group">
      <label class="filter-label" for="speciesSelect">V√¶lg art(er)</label>
      <select id="speciesSelect" class="filter-multiselect" multiple></select>
    </div>

    <div class="filter-group">
      <label class="filter-label" for="presenceSelect">Registreringsstatus</label>
      <select id="presenceSelect" class="filter-select">
        <option value="absent">Ikke registreret</option>
        <option value="one">Registreret i √©n pr√∏ve</option>
        <option value="both">Registreret i begge pr√∏ver</option>
      </select>
    </div>

    <div class="filter-group filter-row">
      <input type="checkbox" id="matchAll" />
      <label for="matchAll" style="font-size: 12px; color: #333;">Match alle valgte arter</label>
    </div>

    <div class="filter-actions">
      <button class="btn btn-primary" id="applyFilterBtn">Anvend filter</button>
      <button class="btn" id="resetFilterBtn">Nulstil</button>
    </div>
  </div>

  <!-- Info panel -->
  <div class="info-panel">
    <button class="info-toggle" onclick="toggleInfo()">
      <span>Om projektet</span>
      <span id="toggle-icon">‚àí</span>
    </button>
    <div class="info-content open" id="info-content">
      <h2>eDNA i nicheomr√•der</h2>
      <p>Dette kort viser resultaterne fra Erhvervsakademi K√∏benhavns forskningsprojekt "eDNA i nicheomr√•der ‚Äì et redskab til at finde oversete invasive og r√∏dlistede arter".</p>
      <p>Projektet udf√∏res i samarbejde mellem Erhvervsakademi K√∏benhavn, Statens Naturhistoriske Museum og Milj√∏styrelsen.</p>

      <h3>Deltagelse</h3>
      <p>Projektet er et Citizen Science-projekt, og vi tilbyder flere m√•der at deltage p√•:</p>

      <h3>Pr√∏vetagning</h3>
      <p>Man kan f√• udleveret et pr√∏vetagningss√¶t og selv indsamle pr√∏verne. Herefter afleveres eller sendes pr√∏verne til os p√•:</p>

      <address>
        <a class="contact-link" href="https://www.google.com/maps?q=Peder+Oxes+All%C3%A9+2,+3400+Hiller%C3%B8d" target="_blank" rel="noopener">
          Peder Oxes All√© 2, 3400 Hiller√∏d
        </a>
      </address>

      <p style="margin-top: 12px;">Vi st√•r for at analysere pr√∏verne.</p>

      <h3>Gymnasieundervisning</h3>
      <p>Det er muligt at tilmelde 10‚Äì12 gymnasieelever til en undervisningsdag hos os. Her kan eleverne medbringe egne pr√∏ver og deltage i analysen af dem.</p>

      <h3>Studerende p√• EK Laboratorie og milj√∏</h3>
      <p>Projektet indg√•r desuden som et frivilligt tilbud til studerende p√• laborant- og milj√∏teknologuddannelsen p√• Erhvervsakademi K√∏benhavn.</p>

      <h3>Kontaktinformation</h3>
      <p>Navn: S√∏ren Thromsholdt Christensen</p>
      <p>
        E‚Äëmail:
        <a class="contact-link" href="mailto:stc@ek.dk">stc@ek.dk</a>
      </p>
    </div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-title">Artsregistrering</div>
    <div class="legend-item">
      <div class="legend-color" style="background: #28a745;"></div>
      <span>Registreret i begge pr√∏ver</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #d4edda;"></div>
      <span>Registreret i √©n pr√∏ve</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #f8d7da;"></div>
      <span>Ikke registreret</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #e9ecef;"></div>
      <span>Ikke analyseret</span>
    </div>
  </div>

  <button class="download-btn" onclick="downloadData()">üì• Hent data</button>

  <div class="loading" id="loading">Indl√¶ser data...</div>

  <!-- JS libs (defer ensures they load before our code runs) -->
  <script
    defer
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script defer src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- App code -->
  <script defer>
    // --- Config ---
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFtEG7yEULkEI2LrdnqX_ZNbHf0VzTBuJpz6r3sPpFeWbrqyzMvWEkpE6mfD9WRSnqo_G8Pw-GT1P5/pub?gid=0&single=true&output=csv';

    const SPECIES_COLUMNS = [
      'Aborre', 'Trepigget hundestejle', 'Europ√¶isk √•l', 'Stor vandsalamander',
      'Solaborre', 'Vandremusling', 'Lille vandsalamander', 'Prymnesium parvum',
      'Flodkrebs', 'Signalkrebs', 'Galizisk sumpkrebs', 'R√∏d√∏ret terrapin',
      'Gr√∏nbroget tudse', 'Strandtudse', 'Europ√¶isk malle', 'Karpe'
    ];

    // --- Map init ---
    let map, markers;
    let allMarkers = [];
